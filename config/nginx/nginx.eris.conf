worker_processes  1;

events {
	worker_connections  1024;
}

http {

  include /etc/nginx/mime.types;
  default_type application/octet-stream;

  map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
  }

  disable_symlinks off;

	sendfile             on;
	keepalive_timeout    65;
	client_max_body_size 50M;

	gzip on;
	gzip_disable "msie6";

	gzip_vary on;
	gzip_proxied any;
	gzip_comp_level 6;
	gzip_buffers 16 8k;
	gzip_http_version 1.1;
	gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

	# Block alihack
	deny 23.27.103.106/32;

	upstream deepdetect_public {
		least_conn;
		server 10.10.77.61:8900 max_fails=3 fail_timeout=30s;
	}

	upstream deepdetect_private {
		least_conn;
		server 10.10.77.61:8910 max_fails=3 fail_timeout=30s;
	}

	upstream deepdetect_training_test {
		least_conn;
		server 10.10.77.61:8911 max_fails=3 fail_timeout=30s;
	}

	upstream jupyter {
		least_conn;
		server 10.10.77.61:8920 fail_timeout=0;
	}

	upstream deepdetect_training {
		least_conn;
		server 10.10.77.102:8500 max_fails=3 fail_timeout=30s;
	}

	upstream react {
		least_conn;
		server react:3000 max_fails=3 fail_timeout=30s;
	}

	server {
		listen 80 default_server;
		listen [::]:80 default_server;

		if ($request_method = 'OPTIONS') {
			return 200;
		}

		root /var/www/html;

		index index.html;

		# To allow POST on static pages
		error_page  405     =200 $uri;

		location / {
			proxy_pass http://react;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection 'upgrade';
			proxy_set_header Host $host;
			proxy_cache_bypass $http_upgrade;
			break;
		}

		location ~* \.(eot|otf|ttf|woff|woff2)$ {
			add_header Access-Control-Allow-Origin *;
		}

    #
    # Documentation access configuration
    #

    location /docs {
      alias   /var/www/html/docs;
    }

		#
    # Jupyter notebook configuration
    #

    location /code {
      proxy_pass http://jupyter;

      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    location ~* /code/(api/kernels/[^/]+/(channels|iopub|shell|stdin)|terminals/websocket)/? {
      proxy_pass http://jupyter;

      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      # WebSocket support
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;
    }

		#location = /code {
    #  rewrite ^/(.*)$ $1/ permanent;
    #}
    #location /code {
    #  error_page 403 = @proxy_jupyter;
    #  deny 127.0.0.1;
    #  allow all;
    #  # set a webroot, if there is one
    #  # root /some-webroot;
    #  try_files $uri @proxy_jupyter;
    #}
    #location @proxy_jupyter {
    #  #rewrite /groot(.*) $1  break;
    #  proxy_read_timeout 300s;
    #  proxy_pass http://jupyter;
    #  # pass some extra stuff to the backend
    #  proxy_set_header Host $host;
    #  proxy_set_header X-Real-Ip $remote_addr;
    #  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #}
		#location ~ /code/api/kernels/ {
		#	proxy_pass            http://jupyter;
		#	proxy_set_header      Host $host;
		#	# websocket support
		#	proxy_http_version    1.1;
		#	proxy_set_header      Upgrade "websocket";
		#	proxy_set_header      Connection "Upgrade";
		#	proxy_read_timeout    86400;
		#}
		#location ~ /code/terminals/ {
		#	proxy_pass            http://jupyter;
		#	proxy_set_header      Host $host;
		#	# websocket support
		#	proxy_http_version    1.1;
		#	proxy_set_header      Upgrade "websocket";
		#	proxy_set_header      Connection "Upgrade";
		#	proxy_read_timeout    86400;
		#}

    #
    # Deepdetect API configuration
    #

		location ~ /api/public/(?<url>.*) {
			proxy_pass http://deepdetect_public/$url$is_args$args;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection 'upgrade';
			proxy_set_header Host $host;
			proxy_cache_bypass $http_upgrade;
		}

		location ~ /api/private/(?<url>.*) {
			proxy_pass http://deepdetect_private/$url$is_args$args;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection 'upgrade';
			proxy_set_header Host $host;
			proxy_cache_bypass $http_upgrade;
		}

		location ~ /api/training/(?<url>.*) {
			proxy_pass http://deepdetect_training/$url$is_args$args;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection 'upgrade';
			proxy_set_header Host $host;
			proxy_cache_bypass $http_upgrade;
		}

		location ~ /api/training_test/(?<url>.*) {
			proxy_pass http://deepdetect_training_test/$url$is_args$args;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection 'upgrade';
			proxy_set_header Host $host;
			proxy_cache_bypass $http_upgrade;
		}

    #
    # Model access configuration
    #

    location /models/private {
      alias /opt/platform/models/private;
      autoindex on;
    }

    location /models/public {
      alias /opt/platform/models/public;
      autoindex on;
    }

    #
    # data access configuration
    #

    location /data {
      alias /opt/platform/data;
      autoindex on;
    }

	}

}
