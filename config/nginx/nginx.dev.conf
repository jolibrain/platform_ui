worker_processes  1;

events {
	worker_connections  1024;
}

http {

	sendfile             on;
	keepalive_timeout    65;
	client_max_body_size 5M;

	gzip on;
	gzip_disable "msie6";

	gzip_vary on;
	gzip_proxied any;
	gzip_comp_level 6;
	gzip_buffers 16 8k;
	gzip_http_version 1.1;
	gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

	# Block alihack
	deny 23.27.103.106/32;

	upstream deepdetect_public {
		least_conn;
		server deepdetect_public:8080 max_fails=3 fail_timeout=30s;
	}

	upstream deepdetect_private {
		least_conn;
		server deepdetect_private:8080 max_fails=3 fail_timeout=30s;
	}

	upstream react {
		least_conn;
		server react:3000 max_fails=3 fail_timeout=30s;
	}

	server {
		listen 80 default_server;
		listen [::]:80 default_server;

		if ($request_method = 'OPTIONS') {
			return 200;
		}

		root /var/www/html;

		index index.html;

		# To allow POST on static pages
		error_page  405     =200 $uri;

		location / {
			proxy_pass http://react;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection 'upgrade';
			proxy_set_header Host $host;
			proxy_cache_bypass $http_upgrade;
			break;
		}

		location ~* \.(eot|otf|ttf|woff|woff2)$ {
			add_header Access-Control-Allow-Origin *;
		}

		location ~ /api/public/(?<url>.*) {
			proxy_pass http://deepdetect_public/$url;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection 'upgrade';
			proxy_set_header Host $host;
			proxy_cache_bypass $http_upgrade;
		}

		location ~ /api/private/(?<url>.*) {
			proxy_pass http://deepdetect_private/$url;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection 'upgrade';
			proxy_set_header Host $host;
			proxy_cache_bypass $http_upgrade;
		}

    location /models/private {
      alias /opt/platform/models/private;
      autoindex on;
    }

    location /models/public {
      alias /opt/platform/models/public;
      autoindex on;
    }

    location /data {
      alias /opt/platform/data;
      autoindex on;
    }

	}

}
